LUD-22: `subscription` base spec.
====================================

`author: michal-podzimek`

---

## Subscription to a service

Content providers needs posibillity to make recurring payments (subscription payments) without user interaction. Instead of sending Lightning invoice to user a service can use pregenerated subscription key (lnurls). There is also specified a "subscription" QR code which contains a specialized `LNURL` which wallet can use to prefill subscription form and send generated LNURL (lnurls) to callback server.

According to LUD-17, there will be used prefix `lnurls://` for LNURL-subscription, i.e. `subscription`;

### Wallet to service interaction flow:

1. `LN SERVICE` generate LNURL QR code
2. User scans a LNURL QR code or accesses an `lightning:LNURL..` link with `LN WALLET` and `LN WALLET` decodes LNURL.
3. `LN WALLET` makes a GET request to `LN SERVICE` using the decoded LNURL.
4. `LN WALLET` gets JSON response from `LN SERVICE` of form:
    ```Typescript
    {
        "tag": "subscription", // type of LNURL
        "model": "recurring" or "pay-per-view", // type subscription
        "callback": string, // The URL which `LN SERVICE` would accept a subscription key (lnurls)
        "subscription_id": string, // `LN SERVICE` unique ID of subscription 
        "limit": {
            "amount": number, // limit amount in limit.currency
            "period": string, // limit period is enum: DAILY, WEEKLY, MONTHLY, YEARLY
            "currency": string, // limit currency is ISO 4217 three characters currency code
            "periodStart": number, // limit periodStart is unix timestamp. In case of recurring model `LN SERVICE` will call LNURLS after this time plus N*period
        }
        "metadata": string, // Metadata json which must be presented as raw string
    }
    ```
    or return standard HTTP error code (404, 500, etc)
    
    `metadata` json array must contain one `text/plain` entry, all other types of entries are optional.
    `metadata` json array must contain either one `image/png;base64` entry or one `image/jpeg;base64` entry or neither.

    The `metadata` json array is only allowed to contain arrays. The first item of an array inside the `metadata` array is always a string representing the metadata type while any item that follows can be of any JSON type. Implementors MUST NOT assume it will always be a string.

    ```Typescript
    [
        [
            "text/plain", // mandatory,
            string // short description displayed when paying and in transaction log
        ],
        [
            "text/long-desc", // optional
            string // longer description of the payment, MAY contain newlines
        ],
        [
            "image/png;base64", // optional
            string // base64 string, 512x512px PNG thumbnail which will represent this lnurl in a list or grid. Up to 136536 characters (100Kb of image data in base-64 encoding)
        ],
        [
            "image/jpeg;base64", // optional
            string // base64 string, 512x512px JPG thumbnail which will represent this lnurl in a list or grid. Up to 136536 characters (100Kb of image data in base-64 encoding)
        ],
        // future entries:
        [
            string,
            any
        ]
    ]
    ```

    and be sent as a string:

    ```JSON
    "[[\"text/plain\", \"lorem ipsum blah blah\"]]"
    ```
    
5. `LN WALLET` Displays a subscription create dialog and show limit values.
6. Once accepted by the user, `LN WALLET` create subscription LNURL and subscription key and sends a POST to `LN SERVICE` in the form of
    ```Typescript
    {
        "action": string, // type of request, in this case "create" for create of subscription
        "subscription_id": string, // `LN SERVICE` unique ID of subscription
        "subscription_key": string, // key generated by `LN WALLET`, must be unique to distinguish subscription
        "subscription_url": string, // LNURL of `LN WALLET`, which is used for accepting invoices or changing subscription details
        "paylink": string, // optional, is raw URL (not bech32-encoded) as described in LUD-17 and is used for getting LN invoice to refund money
    }
    ```
7. `LN SERVICE` returns HTTP code 200

### Error codes
In case of error return of HTTP code 400 or 404 and POST response will be in form of
```Typescript
{
    "code": string,
    "message": string
}
```

#### Error code types

| Prefix    | Description |
| -------- | ------- |
| Without prefix  | General error between `LN SERVICE` and `LN WALLET`    |
| w0020 | Standardized error caused by LNURLS state (not found, deleted, expired, not valid lnurls key, ...)    |

#### Detailed error codes

| Error code    | Description |
| -------- | ------- |
| w0020_lnurls_not_found | LNURLS not found |

## Payment of the invoice
1. `LN SERVICE` sends a POST to "subscription_url" in form of
    ```Typescript
    {
        "subscription_id": string, // `LN SERVICE` unique ID of subscription
        "subscription_key": string, // key generated by `LN WALLET`
        "pr": string, // invoice to be payed by `LN WALLET`
    }
    ```
2. `LN WALLET` (Možná přepsat do odrážek) checks:
- "subscription_id" exists and the subscription is not cancelled
- "subscription_key" is correct
- invoice is not expired
- invoice amount does not exceed the allowed limit
  - amount is calculated in the currency that was defined for the limit
  - period for the check is counted from the moment periodStart + n * period (for example: periodStart.day | periodStart.month + n | periodStart.year | periodStart.time), where n is the highest possible for the given moment to be in the past. If the date does not exist, then the last valid date in the same month as calculated is used.
3. If the check is successful `LN WALLET` pays the invoice and return HTTP code 200

### Error codes
In case of error return of HTTP code 400 or 404 and POST response will be in form of
```Typescript
{
    "code": string,
    "message": string
}
```

#### Error code types

| Prefix    | Description |
| -------- | ------- |
| Without prefix  | General error between `LN SERVICE` and `LN WALLET`    |
| w0000 | General standard error   |
| w0010 | Standardized error caused by invoice amount and user balance or subscription limit    |
| w0020 | Standardized error caused by LNURLS state (not found, deleted, expired, not valid lnurls key, ...)    |
| w0030 | Standardized error of lightning invoice (expired, without amount, ...)    |

#### Detailed error codes

| Error code    | Description |
| -------- | ------- |
| w0010_insufficient_balance | User balance is insufficient |
| w0010_exceeded_lnurls_amount_limit | Amount limit was exceeded for LNURLS |
| w0010_exceeded_lnurls_invoices_count_limit | Invoices count limit was exceeded for LNURLS |
| w0020_lnurls_not_found | LNURLS not found |
| w0030_invalid_lightning_invoice_state | Lightning invoice is in invalid state |
| w0030_invalid_bolt11 | Invalid bolt11 |
| w0030_lightning_invoice_expire | Lightning invoice expired |
| w0030_bolt11_already_in_process | Lightning bolt11 invoice is already in process |
| w0030_amount_must_be_greater_than_zero | Amount must be greater than zero |


## Subscription cancellation
1. `LN WALLET` sends a POST to "subscription_url" in form of
    ```Typescript
    {
        "action": string, // type of request, in this case "cancel"
        "subscription_id": string, // `LN SERVICE` unique ID of subscription
        "subscription_key": string, // key generated by `LN WALLET`
    }
    ```
2. `LN WALLET` internally mark subscription as canceled and no payment will be allowed
3. `LN SERVICE` internally mark subscription as canceled and no payment will be charged


## Subscription updating
1. `LN WALLET` sends a POST to "subscription_url" in form of
    ```Typescript
    {
        "action": string, // type of request, in this case "update"
        "subscription_id": string, // `LN SERVICE` unique ID of subscription
        "subscription_key": string, // key generated by `LN WALLET`
        "limit": {
            "amount": number, // limit amount
        }
    }
    
    ```
2. `LN WALLET` internally updates subcription limits
3. `LN SERVICE` internally updates subcription limits

// TODO ERROR kody